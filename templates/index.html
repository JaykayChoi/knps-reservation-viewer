<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜ˆì•½ ê°€ëŠ¥í•œ íŠ¹í™”ì•¼ì˜ì¥/ì¹´ë¼ë°˜</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    .controls { display:flex; align-items:center; gap:1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .check-group { display:flex; gap:0.75rem; align-items:center; }
    .item { margin-bottom: 1em; padding: 0.5em; border: 1px solid #ccc; border-radius: 6px; }
    .date-label { font-weight: bold; margin-top: 2em; font-size: 1.2em; }
    .footer-link { margin-top: 3em; text-align: center; font-size: 1.1em; }
    .footer-link a { text-decoration: none; font-weight: bold; color: #2c3e50; }
    .footer-link a:hover { text-decoration: underline; }
    .muted { color:#666; font-size:0.95em; }
    button.refresh { padding:0.5rem 0.9rem; border:1px solid #aaa; border-radius:8px; background:#f8f8f8; cursor:pointer; }
    button.refresh:hover { background:#f0f0f0; }
  </style>
</head>
<body>
  <h1>ì˜ˆì•½ ê°€ëŠ¥í•œ íŠ¹í™”ì•¼ì˜ì¥/ì¹´ë¼ë°˜</h1>

  <div class="controls">
    <div class="check-group">
      <label><input type="checkbox" class="day-check" value="4"> ê¸ˆìš”ì¼</label>
      <label><input type="checkbox" class="day-check" value="5"> í† ìš”ì¼</label>
      <label><input type="checkbox" class="day-check" value="6"> ì¼ìš”ì¼</label>
    </div>
    <button id="btn-refresh" class="refresh">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
    <span id="selected-label" class="muted"></span>
  </div>

  <div id="list"><h2>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2></div>

  <div class="footer-link">
    <a href="https://reservation.knps.or.kr/reservation/searchSimpleCampReservation.do"
       target="_blank" rel="noopener noreferrer">
      ğŸ‘‰ êµ­ë¦½ê³µì› ì˜ˆì•½ í˜ì´ì§€ ë°”ë¡œê°€ê¸°
    </a>
  </div>

  <script>
    const KEY = 'selectedDays'; // localStorage key
    const DAY_LABELS = {4:'ê¸ˆìš”ì¼', 5:'í† ìš”ì¼', 6:'ì¼ìš”ì¼'};

    function formatDisplayDate(dateStr) {
      return `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}`;
    }

    function getSelectedDays() {
      const raw = localStorage.getItem(KEY);
      if (raw) {
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length) return arr.map(Number);
        } catch {}
      }
      // ê¸°ë³¸ê°’: í† ìš”ì¼
      return [5];
    }

    function setSelectedDays(days) {
      localStorage.setItem(KEY, JSON.stringify(days.map(Number)));
    }

    function applySelectionsToUI(days) {
      document.querySelectorAll('.day-check').forEach(cb => {
        cb.checked = days.includes(Number(cb.value));
      });
      const label = days.length
        ? 'ì„ íƒí•œ ìš”ì¼: ' + days.map(d => DAY_LABELS[d]).join(', ')
        : 'ì„ íƒí•œ ìš”ì¼ ì—†ìŒ (ê¸°ë³¸: í† ìš”ì¼)';
      document.getElementById('selected-label').textContent = label;
    }

    function buildDaysQueryParam(days) {
      // ë°±ì—”ë“œì—ì„œ Python weekday() ê¸°ì¤€: ì›”=0 ... ì¼=6
      // ìš°ë¦¬ê°€ ì‚¬ìš©í•˜ëŠ” ê°’ ê·¸ëŒ€ë¡œ ì „ì†¡ (ê¸ˆ=4, í† =5, ì¼=6)
      return days.join(',');
    }

    async function fetchAndRender() {
      const days = getSelectedDays();
      applySelectionsToUI(days);

      const list = document.getElementById('list');
      list.innerHTML = '<h2>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>';

      const qs = days.length ? `?days=${encodeURIComponent(buildDaysQueryParam(days))}` : '?days=5';
      try {
        const res = await fetch(`/api/reservations${qs}`);
        const data = await res.json();

        list.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
          list.innerHTML = '<h2>ì˜ˆì•½ ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</h2>';
          return;
        }

        // ë‚ ì§œë³„ ê·¸ë£¹í™”
        const grouped = {};
        data.forEach(item => {
          const date = item.query_date;
          if (!grouped[date]) grouped[date] = [];
          grouped[date].push(item);
        });

        Object.keys(grouped).sort().forEach(date => {
          const section = document.createElement('div');
          const formattedDate = formatDisplayDate(date);
          section.innerHTML = `<div class="date-label">ğŸ“… ${formattedDate}</div>`;

          grouped[date].forEach(item => {
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
              <strong>${item.officeNm} - ${item.deptNm} - ${item.prdCtgNm}</strong><br>
              ì „ì²´: ${item.prdIdCnt} / ì˜ˆì•½ ê°€ëŠ¥: ${item.cntN} / ì™„ë£Œ: ${item.cntC} / ë‹¹ì¼: ${item.cntR}
            `;
            section.appendChild(div);
          });

          list.appendChild(section);
        });
      } catch (err) {
        console.error(err);
        list.innerHTML = '<h2>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</h2>';
      }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
      document.querySelectorAll('.day-check').forEach(cb => {
        cb.addEventListener('change', () => {
          const selected = Array.from(document.querySelectorAll('.day-check'))
            .filter(x => x.checked)
            .map(x => Number(x.value));
          // ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ê¸°ë³¸ê°’(í† ìš”ì¼)ë¡œ
          const days = selected.length ? selected : [5];
          setSelectedDays(days);
          fetchAndRender();
        });
      });

      // ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
      document.getElementById('btn-refresh').addEventListener('click', () => {
        fetchAndRender();
      });

      // ì €ì¥ëœ ì„ íƒ ë³µì› í›„ ë°ì´í„° ë¡œë“œ
      applySelectionsToUI(getSelectedDays());
      fetchAndRender();
    });
  </script>
</body>
</html>
