<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ˆì•½ ê°€ëŠ¥í•œ íŠ¹í™”ì•¼ì˜ì¥/ì¹´ë¼ë°˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      --gap: 1rem;
      --card-radius: 10px;
      --touch-size: 20px;
      --checkbox-scale: 1.15;
      --text-muted: #666;
      --border: #ccc;
    }

    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 1rem; }
    h1 { margin: 0 0 0.75rem; }

    .controls {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: var(--gap);
      align-items: start;
      margin-bottom: 0.75rem;
    }
    @media (max-width: 640px) {
      .controls { grid-template-columns: 1fr; }
    }

    .check-wrap { display: grid; gap: 0.6rem; }
    .group-title { font-weight: 600; margin-bottom: -0.2rem; }
    .row { display:flex; flex-wrap:wrap; gap: 0.6rem 1rem; align-items:center; }

    .check-group { display: flex; flex-wrap: wrap; gap: 0.8rem 1.2rem; }

    .check {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-height: var(--touch-size);
      padding: 0.2rem 0.3rem;
      border-radius: 8px;
    }
    .check input[type="checkbox"] {
      width: var(--touch-size);
      height: var(--touch-size);
      transform: scale(var(--checkbox-scale));
      transform-origin: left center;
      accent-color: #2c7be5;
    }
    .check span { font-size: 1.05rem; }

    .select {
      display:flex; align-items:center; gap:0.5rem;
      font-size: 1rem;
    }
    .select select, .select input[type="date"] {
      font-size: 1rem;
      padding: 0.4rem 0.6rem;
      border: 1px solid #aaa;
      border-radius: 8px;
      background:#fff;
    }

    button.refresh {
      justify-self: start;
      padding: 0.6rem 1rem;
      border: 1px solid #aaa;
      border-radius: 10px;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 1rem;
    }
    button.refresh:active { transform: translateY(1px); }
    button.refresh:hover { background: #f0f0f0; }

    .muted { color: var(--text-muted); font-size: 0.95rem; }

    .item {
      margin-bottom: 1em;
      padding: 0.75em;
      border: 1px solid var(--border);
      border-radius: var(--card-radius);
      background: #fff;
    }
    .date-label { font-weight: bold; margin: 1.5em 0 0.6em; font-size: 1.15em; }

    .footer-link { margin-top: 2rem; text-align: center; font-size: 1.05em; }
    .footer-link a { text-decoration: none; font-weight: bold; color: #2c3e50; }
    .footer-link a:hover { text-decoration: underline; }

    .hint { font-size: 0.9rem; color: #555; }
  </style>
</head>
<body>
  <h1>ì˜ˆì•½ ê°€ëŠ¥í•œ íŠ¹í™”ì•¼ì˜ì¥/ì¹´ë¼ë°˜</h1>

  <div class="controls">
    <div class="check-wrap">
      <div class="group-title">ìš”ì¼</div>
      <div class="check-group" id="days-group">
        <label class="check"><input type="checkbox" class="day-check" value="4" /><span>ê¸ˆìš”ì¼</span></label>
        <label class="check"><input type="checkbox" class="day-check" value="5" /><span>í† ìš”ì¼</span></label>
        <label class="check"><input type="checkbox" class="day-check" value="6" /><span>ì¼ìš”ì¼</span></label>
      </div>

      <div class="group-title" style="margin-top:0.4rem;">ì‹œì„¤</div>
      <div class="check-group" id="types-group">
        <label class="check"><input type="checkbox" class="type-check" value="íŠ¹í™”ì•¼ì˜ì¥" /><span>íŠ¹í™”ì•¼ì˜ì¥</span></label>
        <label class="check"><input type="checkbox" class="type-check" value="ì¹´ë¼ë°˜" /><span>ì¹´ë¼ë°˜</span></label>
      </div>

      <div class="row">
        <div class="select">
          <label for="weeks-select">ì¡°íšŒ ë²”ìœ„:</label>
          <select id="weeks-select">
            <option value="1">1ì£¼</option>
            <option value="2">2ì£¼</option>
            <option value="3">3ì£¼</option>
            <option value="4">4ì£¼</option>
            <option value="5">5ì£¼</option>
            <option value="6">6ì£¼</option>
            <option value="7">7ì£¼</option>
            <option value="8">8ì£¼ (ê¸°ë³¸)</option>
            <option value="9">9ì£¼</option>
            <option value="10">10ì£¼</option>
          </select>
        </div>

        <!-- âœ… ì¶”ê°€ ë‚ ì§œ ë²”ìœ„ (ìˆìœ¼ë©´ ìš”ì¼+ì£¼ìˆ˜ì™€ í•©ì§‘í•©ìœ¼ë¡œ ì¡°íšŒ) -->
        <div class="select">
          <label for="start-date">ì‹œì‘:</label>
          <input type="date" id="start-date" />
          <label for="end-date">ì¢…ë£Œ:</label>
          <input type="date" id="end-date" />
        </div>

        <button id="btn-refresh" class="refresh">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div class="muted" id="selected-label"></div>
      <div class="hint">â€» ì„ íƒí•œ ìš”ì¼(ê¸ˆÂ·í† Â·ì¼ ë“±) + ì§€ì •í•œ ê¸°ê°„(ìˆë‹¤ë©´)ì„ <b>í•©ì§‘í•©</b>ìœ¼ë¡œ ì¡°íšŒí•©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <div id="list"><h2>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2></div>

  <div class="footer-link">
    <a href="https://reservation.knps.or.kr/reservation/searchSimpleCampReservation.do"
       target="_blank" rel="noopener noreferrer">
      ğŸ‘‰ êµ­ë¦½ê³µì› ì˜ˆì•½ í˜ì´ì§€ ë°”ë¡œê°€ê¸°
    </a>
  </div>

  <script>
    const DAY_KEY   = 'selectedDays';
    const TYPE_KEY  = 'selectedTypes';
    const WEEKS_KEY = 'weeksAhead';
    const START_KEY = 'customStartDate'; // YYYY-MM-DD
    const END_KEY   = 'customEndDate';   // YYYY-MM-DD

    const DAY_LABELS = {0:'ì¼',1:'ì›”',2:'í™”',3:'ìˆ˜',4:'ëª©',5:'ê¸ˆ',6:'í† '}; // Date.getDay()
    const PYWDAY_LABELS = {4:'ê¸ˆìš”ì¼',5:'í† ìš”ì¼',6:'ì¼ìš”ì¼'};            // Python weekday() ê°’ìš© í‘œê¸°

    function formatDisplayDate(yyyymmdd) {
      const y = Number(yyyymmdd.slice(0,4));
      const m = Number(yyyymmdd.slice(4,6));
      const d = Number(yyyymmdd.slice(6,8));
      const dt = new Date(y, m - 1, d);
      const week = DAY_LABELS[dt.getDay()];
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')} (${week})`;
    }

    // ì €ì¥/ë³µì› (ìš”ì¼)
    function getSelectedDays() {
      const raw = localStorage.getItem(DAY_KEY);
      if (raw) {
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length) return arr.map(Number);
        } catch {}
      }
      return [5]; // ê¸°ë³¸: í† ìš”ì¼
    }
    function setSelectedDays(days) {
      localStorage.setItem(DAY_KEY, JSON.stringify(days.map(Number)));
    }

    // ì €ì¥/ë³µì› (ì‹œì„¤)
    function getSelectedTypes() {
      const raw = localStorage.getItem(TYPE_KEY);
      if (raw) {
        try {
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length) return arr;
        } catch {}
      }
      return ["íŠ¹í™”ì•¼ì˜ì¥", "ì¹´ë¼ë°˜"];
    }
    function setSelectedTypes(types) {
      localStorage.setItem(TYPE_KEY, JSON.stringify(types));
    }

    // ì €ì¥/ë³µì› (ì£¼ìˆ˜)
    function getWeeksAhead() {
      const raw = localStorage.getItem(WEEKS_KEY);
      const v = Number(raw);
      if (Number.isInteger(v) && v >= 1 && v <= 10) return v;
      return 8;
    }
    function setWeeksAhead(v) {
      localStorage.setItem(WEEKS_KEY, String(v));
    }

    // ì €ì¥/ë³µì› (ì¶”ê°€ ë‚ ì§œ ë²”ìœ„)
    function getStartDate() {
      const s = localStorage.getItem(START_KEY) || '';
      return /^\d{4}-\d{2}-\d{2}$/.test(s) ? s : '';
    }
    function setStartDate(v) {
      if (v && /^\d{4}-\d{2}-\d{2}$/.test(v)) localStorage.setItem(START_KEY, v);
      else localStorage.removeItem(START_KEY);
    }
    function getEndDate() {
      const s = localStorage.getItem(END_KEY) || '';
      return /^\d{4}-\d{2}-\d{2}$/.test(s) ? s : '';
    }
    function setEndDate(v) {
      if (v && /^\d{4}-\d{2}-\d{2}$/.test(v)) localStorage.setItem(END_KEY, v);
      else localStorage.removeItem(END_KEY);
    }

    function applySelectionsToUI(days, types, weeks, startDate, endDate) {
      document.querySelectorAll('.day-check').forEach(cb => {
        cb.checked = days.includes(Number(cb.value));
      });
      document.querySelectorAll('.type-check').forEach(cb => {
        cb.checked = types.includes(cb.value);
      });
      document.getElementById('weeks-select').value = String(weeks);

      document.getElementById('start-date').value = startDate || '';
      document.getElementById('end-date').value   = endDate || '';

      const labelDays  = (days.length ? days.map(d => PYWDAY_LABELS[d]).join(', ') : 'ì—†ìŒ');
      const labelTypes = (types.length ? types.join(', ') : 'ì—†ìŒ');
      let labelText = `ì„ íƒí•œ ìš”ì¼: ${labelDays} / ì„ íƒí•œ ì‹œì„¤: ${labelTypes} / ì¡°íšŒ ë²”ìœ„: ${weeks}ì£¼`;
      if (startDate && endDate) {
        labelText += ` / ì¶”ê°€ ê¸°ê°„: ${startDate} ~ ${endDate} (í•©ì§‘í•©)`;
      }
      document.getElementById('selected-label').textContent = labelText;
    }

    // âœ… í•­ìƒ days/weeks/typesëŠ” ë³´ë‚´ê³ , start/endëŠ” â€˜ìˆìœ¼ë©´ ì¶”ê°€â€™ë¡œ ë¶™ì„
    function buildQueryParams(days, types, weeks, startDate, endDate) {
      const dayParam   = (days.length ? days.join(',') : '5');
      const typeParam  = (types.length ? types.join(',') : 'íŠ¹í™”ì•¼ì˜ì¥,ì¹´ë¼ë°˜');
      const weeksParam = (Number.isInteger(weeks) && weeks >= 1 && weeks <= 10) ? weeks : 8;

      let qs = `?days=${encodeURIComponent(dayParam)}&types=${encodeURIComponent(typeParam)}&weeks=${weeksParam}`;
      if (startDate && endDate) {
        qs += `&start_date=${encodeURIComponent(startDate)}&end_date=${encodeURIComponent(endDate)}`;
      }
      return qs;
    }

    async function fetchAndRender() {
      const days      = getSelectedDays();
      const types     = getSelectedTypes();
      const weeks     = getWeeksAhead();
      const startDate = getStartDate();
      const endDate   = getEndDate();

      applySelectionsToUI(days, types, weeks, startDate, endDate);

      const list = document.getElementById('list');
      list.innerHTML = '<h2>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>';

      try {
        const qs = buildQueryParams(days, types, weeks, startDate, endDate);
        const res = await fetch(`/api/reservations${qs}`);
        const data = await res.json();

        list.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
          list.innerHTML = '<h2>ì˜ˆì•½ ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</h2>';
          return;
        }

        // ë‚ ì§œë³„ ê·¸ë£¹í™”
        const grouped = {};
        for (const item of data) {
          const date = item.query_date;
          if (!grouped[date]) grouped[date] = [];
          grouped[date].push(item);
        }

        Object.keys(grouped).sort().forEach(date => {
          const section = document.createElement('div');
          const formattedDate = formatDisplayDate(date);
          section.innerHTML = `<div class="date-label">ğŸ“… ${formattedDate}</div>`;

          grouped[date].forEach(item => {
            const div = document.createElement("div");
            div.className = "item";
            div.innerHTML = `
              <strong>${item.officeNm} - ${item.deptNm} - ${item.prdCtgNm}</strong><br>
              ì „ì²´: ${item.prdIdCnt} / ì˜ˆì•½ ê°€ëŠ¥: ${item.cntN} / ì™„ë£Œ: ${item.cntC} / ë‹¹ì¼: ${item.cntR}
            `;
            section.appendChild(div);
          });

          list.appendChild(section);
        });
      } catch (err) {
        console.error(err);
        list.innerHTML = '<h2>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</h2>';
      }
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      // ìš”ì¼ ì²´í¬
      document.querySelectorAll('.day-check').forEach(cb => {
        cb.addEventListener('change', () => {
          const selected = Array.from(document.querySelectorAll('.day-check'))
            .filter(x => x.checked)
            .map(x => Number(x.value));
          setSelectedDays(selected.length ? selected : [5]);
          fetchAndRender();
        });
      });

      // ì‹œì„¤ ì²´í¬
      document.querySelectorAll('.type-check').forEach(cb => {
        cb.addEventListener('change', () => {
          const selected = Array.from(document.querySelectorAll('.type-check'))
            .filter(x => x.checked)
            .map(x => x.value);
          setSelectedTypes(selected.length ? selected : ["íŠ¹í™”ì•¼ì˜ì¥", "ì¹´ë¼ë°˜"]);
          fetchAndRender();
        });
      });

      // ì£¼ìˆ˜ ì„ íƒ
      document.getElementById('weeks-select').addEventListener('change', (e) => {
        const v = Number(e.target.value);
        const weeks = (Number.isInteger(v) && v >= 1 && v <= 10) ? v : 8;
        setWeeksAhead(weeks);
        fetchAndRender();
      });

      // ë‚ ì§œ ì…ë ¥
      const startInput = document.getElementById('start-date');
      const endInput   = document.getElementById('end-date');

      startInput.addEventListener('change', () => {
        const v = startInput.value;
        setStartDate(v);
        const endVal = endInput.value;
        if (endVal && v && endVal < v) {
          endInput.value = '';
          setEndDate('');
        }
        fetchAndRender();
      });

      endInput.addEventListener('change', () => {
        const v = endInput.value;
        setEndDate(v);
        const startVal = startInput.value;
        if (startVal && v && startVal > v) {
          startInput.value = '';
          setStartDate('');
        }
        fetchAndRender();
      });

      // ìµœì´ˆ ë¡œë“œ
      applySelectionsToUI(getSelectedDays(), getSelectedTypes(), getWeeksAhead(), getStartDate(), getEndDate());
      fetchAndRender();
    });
  </script>
</body>
</html>
