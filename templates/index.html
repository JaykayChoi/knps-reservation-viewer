<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ˆì•½ ê°€ëŠ¥í•œ íŠ¹í™”ì•¼ì˜ì¥/ì¹´ë¼ë°˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    :root {
      --gap: 1rem; --card-radius: 10px; --touch-size: 20px;
      --checkbox-scale: 1.15; --text-muted: #666; --border: #ccc;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 1rem; }
    h1 { margin: 0 0 0.75rem; }
    .controls { display: grid; grid-template-columns: 1fr auto; gap: var(--gap); align-items: start; margin-bottom: 0.75rem; }
    @media (max-width: 640px) { .controls { grid-template-columns: 1fr; } }
    .check-wrap { display: grid; gap: 0.6rem; }
    .group-title { font-weight: 600; margin-bottom: -0.2rem; }
    .row { display: flex; flex-wrap: wrap; gap: 0.6rem 1rem; align-items: center; }
    .check-group { display: flex; flex-wrap: wrap; gap: 0.8rem 1.2rem; }
    .check { display: inline-flex; align-items: center; gap: 0.5rem; min-height: var(--touch-size); padding: 0.2rem 0.3rem; border-radius: 8px; }
    .check input[type="checkbox"] { width: var(--touch-size); height: var(--touch-size); transform: scale(var(--checkbox-scale)); transform-origin: left center; accent-color: #2c7be5; }
    .check span { font-size: 1.05rem; }
    .select, .date-picker { display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; }
    .select select, .date-picker input { font-size: 1rem; padding: 0.4rem 0.6rem; border: 1px solid #aaa; border-radius: 8px; background: #fff; }
    button.refresh, button.clear-dates { justify-self: start; padding: 0.6rem 1rem; border: 1px solid #aaa; border-radius: 10px; background: #f7f7f7; cursor: pointer; font-size: 1rem; }
    button.refresh:active, button.clear-dates:active { transform: translateY(1px); }
    button.refresh:hover, button.clear-dates:hover { background: #f0f0f0; }
    .muted { color: var(--text-muted); font-size: 0.95rem; }
    .item { margin-bottom: 1em; padding: 0.75em; border: 1px solid var(--border); border-radius: var(--card-radius); background: #fff; }
    .date-label { font-weight: bold; margin: 1.5em 0 0.6em; font-size: 1.15em; }
    .footer-link { margin-top: 2rem; text-align: center; font-size: 1.05em; }
    .footer-link a { text-decoration: none; font-weight: bold; color: #2c3e50; }
    .footer-link a:hover { text-decoration: underline; }
    fieldset { border: none; padding: 0; margin: 0; }
    fieldset:disabled { opacity: 0.5; }
  </style>
</head>
<body>
  <h1>ì˜ˆì•½ ê°€ëŠ¥í•œ íŠ¹í™”ì•¼ì˜ì¥/ì¹´ë¼ë°˜</h1>
  <div class="controls">
    <div class="check-wrap">
      <div class="group-title">ê¸°ê°„ ì§€ì • (ìš°ì„  ì ìš©)</div>
      <div class="row">
        <div class="date-picker">
          <input type="date" id="start-date"> <span>~</span> <input type="date" id="end-date">
        </div>
        <button id="btn-clear-dates" class="clear-dates">ì´ˆê¸°í™”</button>
      </div>

      <fieldset id="weeks-days-fieldset">
        <div class="group-title" style="margin-top:0.4rem;">ìš”ì¼/ì£¼ ë‹¨ìœ„ ì§€ì •</div>
        <div class="check-group" id="days-group">
          <label class="check"><input type="checkbox" class="day-check" value="4" /><span>ê¸ˆìš”ì¼</span></label>
          <label class="check"><input type="checkbox" class="day-check" value="5" /><span>í† ìš”ì¼</span></label>
          <label class="check"><input type="checkbox" class="day-check" value="6" /><span>ì¼ìš”ì¼</span></label>
        </div>
        <div class="row" style="margin-top: 0.8rem;">
            <div class="select">
              <label for="weeks-select">ì¡°íšŒ ë²”ìœ„:</label>
              <select id="weeks-select">
                <option value="1">1ì£¼</option> <option value="2">2ì£¼</option>
                <option value="3">3ì£¼</option> <option value="4">4ì£¼</option>
                <option value="5">5ì£¼</option> <option value="6">6ì£¼</option>
                <option value="7">7ì£¼</option> <option value="8" selected>8ì£¼ (ê¸°ë³¸)</option>
                <option value="9">9ì£¼</option> <option value="10">10ì£¼</option>
              </select>
            </div>
        </div>
      </fieldset>
      
      <div class="group-title" style="margin-top:0.4rem;">ì‹œì„¤</div>
      <div class="check-group" id="types-group">
        <label class="check"><input type="checkbox" class="type-check" value="íŠ¹í™”ì•¼ì˜ì¥" /><span>íŠ¹í™”ì•¼ì˜ì¥</span></label>
        <label class="check"><input type="checkbox" class="type-check" value="ì¹´ë¼ë°˜" /><span>ì¹´ë¼ë°˜</span></label>
      </div>

      <div class="row" style="margin-top: 0.4rem;">
        <button id="btn-refresh" class="refresh">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div class="muted" id="selected-label"></div>
    </div>
  </div>
  <div id="list"><h2>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2></div>
  <div class="footer-link">
    <a href="https://reservation.knps.or.kr/reservation/searchSimpleCampReservation.do" target="_blank" rel="noopener noreferrer">
      ğŸ‘‰ êµ­ë¦½ê³µì› ì˜ˆì•½ í˜ì´ì§€ ë°”ë¡œê°€ê¸°
    </a>
  </div>

<script>
    const DAY_KEY = 'selectedDays', TYPE_KEY = 'selectedTypes', WEEKS_KEY = 'weeksAhead';
    const START_DATE_KEY = 'startDate', END_DATE_KEY = 'endDate';
    const DAY_LABELS = {0:'ì¼',1:'ì›”',2:'í™”',3:'ìˆ˜',4:'ëª©',5:'ê¸ˆ',6:'í† '};
    const PYWDAY_LABELS = {4:'ê¸ˆìš”ì¼',5:'í† ìš”ì¼',6:'ì¼ìš”ì¼'};

    function formatDisplayDate(dateStr) {
        const y = Number(dateStr.slice(0,4)), m = Number(dateStr.slice(4,6)), d = Number(dateStr.slice(6,8));
        const dt = new Date(y, m - 1, d);
        return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')} (${DAY_LABELS[dt.getDay()]})`;
    }

    function getSelectedDays() {
        const raw = localStorage.getItem(DAY_KEY);
        if (raw) { try { const arr = JSON.parse(raw); if (Array.isArray(arr) && arr.length) return arr.map(Number); } catch {} }
        return [5];
    }
    function setSelectedDays(days) { localStorage.setItem(DAY_KEY, JSON.stringify(days.map(Number))); }

    function getSelectedTypes() {
        const raw = localStorage.getItem(TYPE_KEY);
        if (raw) { try { const arr = JSON.parse(raw); if (Array.isArray(arr) && arr.length) return arr; } catch {} }
        return ["íŠ¹í™”ì•¼ì˜ì¥", "ì¹´ë¼ë°˜"];
    }
    function setSelectedTypes(types) { localStorage.setItem(TYPE_KEY, JSON.stringify(types)); }

    function getWeeksAhead() {
        const v = Number(localStorage.getItem(WEEKS_KEY));
        if (Number.isInteger(v) && v >= 1 && v <= 10) return v;
        return 8;
    }
    function setWeeksAhead(v) { localStorage.setItem(WEEKS_KEY, String(v)); }

    function getStartDate() { return localStorage.getItem(START_DATE_KEY) || ''; }
    function setStartDate(date) { date ? localStorage.setItem(START_DATE_KEY, date) : localStorage.removeItem(START_DATE_KEY); }
    function getEndDate() { return localStorage.getItem(END_DATE_KEY) || ''; }
    function setEndDate(date) { date ? localStorage.setItem(END_DATE_KEY, date) : localStorage.removeItem(END_DATE_KEY); }


    function applySelectionsToUI(days, types, weeks, startDate, endDate) {
        document.querySelectorAll('.day-check').forEach(cb => { cb.checked = days.includes(Number(cb.value)); });
        document.querySelectorAll('.type-check').forEach(cb => { cb.checked = types.includes(cb.value); });
        document.getElementById('weeks-select').value = String(weeks);
        document.getElementById('start-date').value = startDate;
        document.getElementById('end-date').value = endDate;

        const isDateRangeSelected = startDate && endDate;
        // âœ… fieldset ì „ì²´ë¥¼ ë¹„í™œì„±í™”/í™œì„±í™”
        document.getElementById('weeks-days-fieldset').disabled = isDateRangeSelected;

        const labelTypes = (types.length ? types.join(', ') : 'ì—†ìŒ');
        let dateInfoLabel = '';
        if (isDateRangeSelected) {
            dateInfoLabel = `ê¸°ê°„ ì§€ì •: ${startDate} ~ ${endDate} (ëª¨ë“  ìš”ì¼)`;
        } else {
            const labelDays = (days.length ? days.map(d => PYWDAY_LABELS[d]).join(', ') : 'ì—†ìŒ');
            dateInfoLabel = `ìš”ì¼: ${labelDays} / ë²”ìœ„: ${weeks}ì£¼`;
        }
        document.getElementById('selected-label').textContent = `${dateInfoLabel} / ì‹œì„¤: ${labelTypes}`;
    }

    function buildQueryParams(days, types, weeks, startDate, endDate) {
        const typeParam = types.join(',') || 'íŠ¹í™”ì•¼ì˜ì¥,ì¹´ë¼ë°˜';
        
        // âœ… ë‚ ì§œ ë²”ìœ„ê°€ ìˆìœ¼ë©´ í•´ë‹¹ íŒŒë¼ë¯¸í„°ë§Œ ì‚¬ìš©
        if (startDate && endDate) {
            return `?start_date=${startDate}&end_date=${endDate}&types=${encodeURIComponent(typeParam)}`;
        }
        
        // ì—†ìœ¼ë©´ ê¸°ì¡´ ìš”ì¼/ì£¼ ë‹¨ìœ„ íŒŒë¼ë¯¸í„° ì‚¬ìš©
        const dayParam = days.join(',') || '5';
        const weeksParam = (Number.isInteger(weeks) && weeks >= 1 && weeks <= 10) ? weeks : 8;
        return `?days=${encodeURIComponent(dayParam)}&types=${encodeURIComponent(typeParam)}&weeks=${weeksParam}`;
    }

    async function fetchAndRender() {
        const days = getSelectedDays(), types = getSelectedTypes(), weeks = getWeeksAhead();
        const startDate = getStartDate(), endDate = getEndDate();

        applySelectionsToUI(days, types, weeks, startDate, endDate);

        const list = document.getElementById('list');
        list.innerHTML = '<h2>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>';

        try {
            const query = buildQueryParams(days, types, weeks, startDate, endDate);
            const res = await fetch(`/api/reservations${query}`);
            const data = await res.json();
            list.innerHTML = '';
            if (!Array.isArray(data) || data.length === 0) {
                list.innerHTML = '<h2>ì˜ˆì•½ ê°€ëŠ¥í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</h2>';
                return;
            }
            const grouped = {};
            for (const item of data) {
                const date = item.query_date;
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(item);
            }
            Object.keys(grouped).sort().forEach(date => {
                const section = document.createElement('div');
                section.innerHTML = `<div class="date-label">ğŸ“… ${formatDisplayDate(date)}</div>`;
                grouped[date].forEach(item => {
                    const div = document.createElement("div");
                    div.className = "item";
                    div.innerHTML = `<strong>${item.officeNm} - ${item.deptNm} - ${item.prdCtgNm}</strong><br>
                                     ì „ì²´: ${item.prdIdCnt} / ì˜ˆì•½ ê°€ëŠ¥: ${item.cntN} / ì™„ë£Œ: ${item.cntC} / ë‹¹ì¼: ${item.cntR}`;
                    section.appendChild(div);
                });
                list.appendChild(section);
            });
        } catch (err) {
            console.error(err);
            list.innerHTML = '<h2>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</h2>';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const setupCheckboxHandler = (selector, setter, defaultVal) => {
            document.querySelectorAll(selector).forEach(cb => {
                cb.addEventListener('change', () => {
                    const selected = Array.from(document.querySelectorAll(`${selector}:checked`))
                        .map(x => selector.includes('day') ? Number(x.value) : x.value);
                    setter(selected.length ? selected : defaultVal);
                    fetchAndRender();
                });
            });
        };
        setupCheckboxHandler('.day-check', setSelectedDays, [5]);
        setupCheckboxHandler('.type-check', setSelectedTypes, ["íŠ¹í™”ì•¼ì˜ì¥", "ì¹´ë¼ë°˜"]);

        document.getElementById('weeks-select').addEventListener('change', (e) => {
            const v = Number(e.target.value);
            setWeeksAhead((Number.isInteger(v) && v >= 1 && v <= 10) ? v : 8);
            fetchAndRender();
        });
        document.getElementById('btn-refresh').addEventListener('click', fetchAndRender);

        const startDateInput = document.getElementById('start-date'), endDateInput = document.getElementById('end-date');
        const handleDateChange = () => {
            if (startDateInput.value && endDateInput.value && endDateInput.value < startDateInput.value) {
                endDateInput.value = startDateInput.value;
            }
            setStartDate(startDateInput.value);
            setEndDate(endDateInput.value);
            // ë‘ ë‚ ì§œê°€ ëª¨ë‘ ì„ íƒë˜ê±°ë‚˜ ëª¨ë‘ ë¹„ì›Œì¡Œì„ ë•Œë§Œ ìƒˆë¡œê³ ì¹¨
            if ((getStartDate() && getEndDate()) || (!getStartDate() && !getEndDate())) {
                fetchAndRender();
            }
        };
        startDateInput.addEventListener('change', handleDateChange);
        endDateInput.addEventListener('change', handleDateChange);

        document.getElementById('btn-clear-dates').addEventListener('click', () => {
            setStartDate('');
            setEndDate('');
            fetchAndRender();
        });

        fetchAndRender();
    });
</script>
</body>
</html>